<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Civic Connect | Report an Issue</title>
  <link rel="icon" href="weblogo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; background: linear-gradient(135deg, #1e40af 0%, #0891b2 50%, #059669 100%); min-height: 100vh; color: #334155; line-height: 1.6; }
    .bg-decoration { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.1; background-image: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.3) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255,255,255,0.2) 0%, transparent 50%); animation: float 8s ease-in-out infinite alternate; }
    @keyframes float { 0% { transform: translateY(0px) rotate(0deg); } 100% { transform: translateY(-30px) rotate(2deg); } }
    .navbar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1.5rem; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(30,64,175,0.1); color: #1e293b; position: sticky; top:0; z-index:1000; box-shadow:0 4px 20px rgba(0,0,0,0.1);}
    .logo img { height:80px; width:90px; border-radius:8px; }
    .nav-links { display:flex; gap:32px; align-items:center; }
    .nav-links a { text-decoration:none; color:#64748b; font-weight:500; font-size:16px; padding:10px 20px; border-radius:8px; transition:all 0.3s ease; position:relative; }
    .nav-links a:hover { color:#1e40af; background: rgba(30,64,175,0.05);}
    .nav-links a.active { color:#f97316; background: rgba(249,115,22,0.1); font-weight:600;}
    .mobile-menu-toggle { display:none; flex-direction:column; cursor:pointer; gap:4px; }
    .mobile-menu-toggle span { width:25px; height:3px; background:#1e40af; border-radius:2px; transition:all 0.3s ease; }
    .welcome-box { padding: 0.5rem 1rem; background: rgb(236, 255, 254); border-radius: 12px; backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(75, 198, 255, 0.3); color: rgb(30, 255, 0); font-size: 1rem; font-weight: 600; text-align: center; max-width: 200px; }
    .container { max-width:1000px; margin:60px auto; padding:0 20px; }
    .page-header { text-align:center; margin-bottom:60px; color:white; }
    .page-header h1 { font-size:3.5rem; font-weight:700; margin-bottom:16px; background: linear-gradient(135deg, #fff, #f1f5f9); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .page-header .highlight { color:#f97316; -webkit-text-fill-color:#f97316; }
    .page-header p { font-size:1.25rem; color:#cbd5e1; max-width:600px; margin:0 auto; font-weight:400; }
    .form-card { background: rgba(255,255,255,0.98); backdrop-filter: blur(20px); border:1px solid rgba(255,255,255,0.2); border-radius:24px; padding:48px; box-shadow:0 25px 50px rgba(0,0,0,0.15),0 0 0 1px rgba(255,255,255,0.1); animation:slideInUp 0.8s ease; }
    @keyframes slideInUp { from { opacity:0; transform:translateY(40px);} to {opacity:1; transform:translateY(0);} }
    form { display:grid; gap:28px; }
    .form-section { margin-bottom:20px; }
    .section-title { font-size:1.5rem; font-weight:700; color:#1e293b; margin-bottom:24px; padding-bottom:12px; border-bottom:2px solid #f1f5f9; }
    .form-group { position:relative; }
    label { display:block; font-weight:600; margin-bottom:8px; color:#374151; font-size:0.95rem; }
    .required { color:#f97316; }
    input, textarea, select { width:100%; padding:16px 20px; border:2px solid #e2e8f0; border-radius:12px; font-size:16px; outline:none; transition:all 0.3s ease; background:#fafafa; font-family:inherit; }
    input:focus, textarea:focus, select:focus { border-color:#0891b2; background:white; box-shadow:0 0 0 4px rgba(8,145,178,0.1); transform:translateY(-1px); }
    textarea { resize:vertical; min-height:120px; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:24px; }
    .file-upload-section { background:#f8fafc; border-radius:16px; padding:32px; border:2px dashed #cbd5e1; transition:all 0.3s ease; }
    .file-upload-area { text-align:center; cursor:pointer; position:relative; overflow:hidden; }
    .file-upload-area.dragover { border-color:#0891b2; background: rgba(8,145,178,0.1); transform:scale(1.02); }
    .upload-icon { width:60px; height:60px; margin:0 auto 20px; background: linear-gradient(135deg, #f97316,#ea580c); border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:24px; }
    .upload-text { font-size:1.1rem; font-weight:600; color:#374151; margin-bottom:8px; }
    .upload-subtext { color:#6b7280; font-size:0.9rem; }
    .file-input { position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer; }
    .uploaded-files { margin-top:24px; display:grid; gap:12px; }
    .file-item { display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background:white; border:1px solid #e2e8f0; border-radius:12px; font-size:0.95rem; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    .file-item-info { display:flex; align-items:center; gap:12px; }
    .file-icon { width:32px; height:32px; background: linear-gradient(135deg,#0891b2,#0e7490); border-radius:6px; display:flex; align-items:center; justify-content:center; color:white; font-size:14px; }
    .file-remove { color:#dc2626; cursor:pointer; font-weight:bold; padding:8px 12px; border-radius:8px; transition:all 0.2s ease; font-size:18px; }
    .file-remove:hover { background: rgba(220,38,38,0.1); }
    .submit-btn { background:linear-gradient(135deg,#f97316,#ea580c); color:white; border:none; padding:20px 48px; border-radius:12px; font-size:18px; font-weight:600; cursor:pointer; transition:all 0.3s ease; position:relative; overflow:hidden; margin-top:32px; box-shadow:0 8px 24px rgba(249,115,22,0.3);}
    .submit-btn::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent); transition:left 0.5s ease;}
    .submit-btn:hover::before { left:100%; }
    .submit-btn:hover { transform:translateY(-2px); box-shadow:0 12px 32px rgba(249,115,22,0.4);}
    .submit-btn:active { transform:translateY(0); }
    .success-message { display:none; text-align:center; padding:24px; background:linear-gradient(135deg,#10b981,#059669); color:white; border-radius:16px; margin-top:24px; animation: successSlide 0.6s ease; font-weight:500; font-size:1.1rem; box-shadow:0 8px 24px rgba(16,185,129,0.3);}
    @keyframes successSlide { 0% { transform:scale(0.8) translateY(20px); opacity:0; } 50% { transform:scale(1.05) translateY(-5px);} 100% { transform:scale(1) translateY(0); opacity:1;} }
    .loading { opacity:0.7; pointer-events:none; }
    .loading .submit-btn { background:#94a3b8; cursor:not-allowed; box-shadow:none; }
    .input-error { border-color:#dc2626 !important; box-shadow:0 0 0 4px rgba(220,38,38,0.1) !important; }
    .input-success { border-color:#10b981 !important; box-shadow:0 0 0 4px rgba(16,185,129,0.1) !important; }
    .error-message { color:#dc2626; font-size:0.875rem; margin-top:4px; display:none; }
    
    /* Responsive */
    @media(max-width:768px){
      .nav-links{display:none;width:100%;flex-direction:column;margin-top:20px;background:white;border-radius:12px;padding:20px;box-shadow:0 4px 20px rgba(0,0,0,0.1);}
      .nav-links.active{display:flex;}
      .nav-links a{padding:16px 0;border-radius:0;border-bottom:1px solid #f1f5f9;}
      .nav-links a:last-child{border-bottom:none;}
      .mobile-menu-toggle{display:flex;}
      .mobile-menu-toggle.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
      .mobile-menu-toggle.active span:nth-child(2){opacity:0;}
      .mobile-menu-toggle.active span:nth-child(3){transform:rotate(-45deg) translate(7px,-6px);}
      .container{margin:40px auto;padding:0 15px;}
      .page-header h1{font-size:2.5rem;}
      .page-header p{font-size:1.1rem;}
      .form-card{padding:32px 24px;border-radius:20px;}
      .form-row{grid-template-columns:1fr;gap:20px;}
      .file-upload-section{padding:24px 16px;}
      .submit-btn{padding:18px 36px;font-size:16px;}
    }
    @media(max-width:480px){
      .navbar{padding:12px 15px;}
      .logo img{height:70px;width:80px;}
      .page-header h1{font-size:2rem;}
      .form-card{padding:24px 16px;margin:0 5px;}
      .section-title{font-size:1.3rem;}
      .submit-btn{padding:16px 32px;font-size:16px;}
    }
  </style>
</head>
<body>
  <div class="bg-decoration"></div>
  <nav class="navbar">
    <div class="logo">
      <img src="reporter.jpg" alt="Civic Connect Logo">
    </div>
    <div class="welcome-box">
      <h2>Welcome User</h2>
    </div>
    <div class="mobile-menu-toggle" id="mobileMenuToggle">
      <span></span><span></span><span></span>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>Report. Track. <span class="highlight">Resolve. Together.</span></h1>
      <p>Empower your community by reporting civic issues for faster resolution and stronger neighborhoods.</p>
    </div>
    <div class="form-card" id="formCard">
      <form id="reportForm" enctype="multipart/form-data">
        <div class="form-section">
          <h3 class="section-title">Personal Information</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="name">Your Name <span class="required">*</span></label>
              <input type="text" name="name" id="name" required placeholder="Enter your full name">
              <div class="error-message" id="nameError"></div>
            </div>
            <div class="form-group">
              <label for="email">Email Address <span class="required">*</span></label>
              <input type="email" name="email" id="email" required placeholder="your.email@example.com">
              <div class="error-message" id="emailError"></div>
            </div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="section-title">Issue Details</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="location">Issue Location <span class="required">*</span></label>
              <input type="text" name="location" id="location" placeholder="Street address, landmark, or area" required>
              <div class="error-message" id="locationError"></div>
            </div>
            <div class="form-group">
              <label for="category">Issue Category <span class="required">*</span></label>
              <select name="category" id="category" required>
                <option value="">Select issue type</option>
                <option value="Road & Infrastructure">🛣️ Road & Infrastructure</option>
                <option value="Street Lighting">💡 Street Lighting</option>
                <option value="Waste Management">🗑️ Waste Management</option>
                <option value="Water & Drainage">💧 Water & Drainage</option>
                <option value="Public Safety">🚨 Public Safety</option>
                <option value="Parks & Recreation">🌳 Parks & Recreation</option>
                <option value="Traffic & Transportation">🚦 Traffic & Transportation</option>
                <option value="Other">📝 Other</option>
              </select>
              <div class="error-message" id="categoryError"></div>
            </div>
          </div>
          <div class="form-group">
            <label for="description">Issue Description <span class="required">*</span></label>
            <textarea name="description" id="description" placeholder="Provide detailed information..." required></textarea>
            <div class="error-message" id="descriptionError"></div>
          </div>
        </div>
        <div class="form-section">
          <h3 class="section-title">Supporting Evidence</h3>
          <div class="file-upload-section">
            <div class="file-upload-area" id="fileUploadArea">
              <div class="upload-icon">📷</div>
              <div class="upload-text">Drop photos here or click to browse</div>
              <div class="upload-subtext">Maximum 5 images, up to 10MB each • JPG, PNG, HEIC supported</div>
              <input type="file" class="file-input" id="fileInput" name="images" multiple accept="image/*">
            </div>
            <div class="uploaded-files" id="uploadedFiles"></div>
          </div>
        </div>
        <button type="submit" class="submit-btn" id="submitBtn">Submit Report</button>
        <div class="success-message" id="successMessage">✅ Your report has been submitted successfully!</div>
      </form>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabaseUrl = 'https://tpcpjxiafgptviandelc.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRwY3BqeGlhZmdwdHZpYW5kZWxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcxNjk4NDcsImV4cCI6MjA3Mjc0NTg0N30.TYcP-D68eufxqnNgjsdMpkt0xoekP-whJZ9mkDgLAdM';
const supabase = createClient(supabaseUrl, supabaseKey);

const reportForm = document.getElementById('reportForm');
const uploadedFilesContainer = document.getElementById('uploadedFiles');
const fileInput = document.getElementById('fileInput');
const fileUploadArea = document.getElementById('fileUploadArea');
const submitBtn = document.getElementById('submitBtn');
let selectedFiles = [];

// ⬇️ NEW CODE: helper to get current location
function getCurrentLocation() {
  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      reject(new Error("Geolocation not supported by this browser."));
    } else {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          resolve({
            latitude: pos.coords.latitude,
            longitude: pos.coords.longitude
          });
        },
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    }
  });
}

// Mock prediction function
const predict = async (imageFile) => {
  try {
    const formData = new FormData();
    formData.append("file", imageFile);
    const response = await fetch("http://127.0.0.1:8000/predict", {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const result = await response.json();
    return result.class;
  } catch (error) {
    console.error("Prediction API error:", error);
    return 'error';
  }
};

// File handling
fileInput.addEventListener('change', e => handleFiles(e.target.files));
fileUploadArea.addEventListener('dragover', e => { e.preventDefault(); fileUploadArea.classList.add('dragover'); });
fileUploadArea.addEventListener('dragleave', () => fileUploadArea.classList.remove('dragover'));
fileUploadArea.addEventListener('drop', e => { e.preventDefault(); fileUploadArea.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });

function handleFiles(files) {
  for (let file of files) {
    if (selectedFiles.length >= 5) { alert('Maximum 5 files allowed'); break; }
    if (file.size > 10 * 1024 * 1024) { alert('Each file must be ≤ 10MB'); continue; }
    selectedFiles.push(file);
  }
  renderFiles();
}

function renderFiles() {
  uploadedFilesContainer.innerHTML = '';
  selectedFiles.forEach((file, index) => {
    const fileItem = document.createElement('div');
    fileItem.classList.add('file-item');
    fileItem.innerHTML = `
      <div class="file-item-info">
        <div class="file-icon">📎</div>
        <span>${file.name}</span>
      </div>
      <div class="file-remove" data-index="${index}">✖</div>`;
    uploadedFilesContainer.appendChild(fileItem);
  });
}

uploadedFilesContainer.addEventListener('click', e => {
  if (e.target.classList.contains('file-remove')) {
    const index = parseInt(e.target.dataset.index);
    selectedFiles.splice(index, 1);
    renderFiles();
  }
});

// Validation helpers
function showError(el, msg) {
  el.classList.add('input-error');
  el.nextElementSibling.style.display = 'block';
  el.nextElementSibling.textContent = msg;
}
function showSuccess(el) {
  el.classList.remove('input-error');
  el.classList.add('input-success');
  el.nextElementSibling.style.display = 'none';
}
function validateField(id, validatorFn, msg) {
  const el = document.getElementById(id);
  if (!validatorFn(el.value.trim())) { showError(el, msg); return false; }
  else { showSuccess(el); return true; }
}

reportForm.addEventListener('submit', async (e) => {
  e.preventDefault();

  // validations
  const isName = validateField('name', v => v.length > 2, 'Enter valid name');
  const isEmail = validateField('email', v => /^\S+@\S+\.\S+$/.test(v), 'Enter valid email');
  const isLocation = validateField('location', v => v.length > 2, 'Enter valid location');
  const isCategory = validateField('category', v => v !== '', 'Select category');
  const isDesc = validateField('description', v => v.length > 5, 'Provide detailed description');
  if (!isName || !isEmail || !isLocation || !isCategory || !isDesc) return;

  submitBtn.classList.add('loading');

  try {
    // Check predictions
    for (const file of selectedFiles) {
      const prediction = await predict(file);
      if (prediction === 'clean') {
        alert('The images appear to be clean, so the report cannot be submitted.');
        submitBtn.classList.remove('loading');
        return;
      }
    }

    // ⬇️ NEW CODE: capture live location
    let geoLocation = null;
    try {
      geoLocation = await getCurrentLocation();
      console.log("Geo captured:", geoLocation);
    } catch (err) {
      console.warn("Geolocation failed:", err.message);
    }

    // Insert report row
    const { data: report, error: reportError } = await supabase
      .from('reports')
      .insert({
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        location: document.getElementById('location').value, // user-typed
        category: document.getElementById('category').value,
        description: document.getElementById('description').value,
        created_at: new Date().toISOString()
      })
      .select("*")
      .single();

    console.log("Report insert result:", { report, reportError });
    if (reportError) throw reportError;

    const { data: locData, error: locationError } = await supabase
  .from('report_locations')
  .insert({
    report_id: report.id,
    latitude: geoLocation?.latitude || null,
    longitude: geoLocation?.longitude || null,
    created_at: new Date().toISOString()
  })
  .select();

console.log("Inserted location row:", locData);
if (locationError) {
  console.error("Report location insert failed:", locationError);
}


    // Upload files + insert rows
    for (let file of selectedFiles) {
      const safeName = file.name.replace(/\s+/g, '_');
      const filePath = `reports/${report.id}/${Date.now()}_${safeName}`;

      // Upload file to storage
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('report-images')
        .upload(filePath, file, { upsert: true });

      if (uploadError) {
        console.error('Upload error:', uploadError);
        continue;
      }
      console.log('Upload success:', uploadData);

      const uploadedPath = uploadData?.path ?? filePath;

      // Get public URL
      const { data: publicUrlData } = supabase.storage
        .from('report-images')
        .getPublicUrl(uploadedPath);

      let finalUrl = publicUrlData?.publicUrl;
      if (!finalUrl) {
        const { data: signedData, error: signedError } = await supabase.storage
          .from('report-images')
          .createSignedUrl(uploadedPath, 3600);
        if (signedError) {
          console.error('Signed URL error:', signedError);
          continue;
        }
        finalUrl = signedData.signedUrl;
      }

      // Insert into report_images
      const { error: imageInsertError } = await supabase
        .from('report_images')
        .insert({
          report_id: report.id,
          image_url: finalUrl,
          uploaded_at: new Date().toISOString()
        });

      if (imageInsertError) {
        console.error("Image insert failed:", imageInsertError);
      } else {
        console.log("Image insert success:", finalUrl);
      }
    }

    // Redirect
    window.location.href = `acknowledgement.html?id=${report.id}`;
  } catch (err) {
    console.error('Submission Error:', err);
    alert('Error submitting report:\n' + (err.message || JSON.stringify(err)));
  } finally {
    submitBtn.classList.remove('loading');
  }
});
</script>





<footer class="site-footer">
  <div class="footer-container">
    <!-- Logo / Branding -->
    <div class="footer-brand">
      <img src="logo.png" alt="Civic Connect Logo" style="width: 120px; margin-bottom: 10px;">
      <h2>Civic Connect</h2>
      <p>Empowering citizens and municipalities for a smarter future.</p>
    </div>

    <!-- Quick Links -->
    <div class="footer-links">
      <h4>Quick Links</h4>
      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Features</a></li>
        <li><a href="#">How It Works</a></li>
        <li><a href="#">Contact</a></li>
      </ul>
    </div>

    <!-- Social Links -->
    <div class="footer-social">
      <h4>Follow Us</h4>
      <div class="social-icons">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-twitter"></i></a>
        <a href="#"><i class="fab fa-linkedin-in"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
      </div>
    </div>
  </div>

  <!-- Bottom -->
  <div class="footer-bottom">
    <p>Made with ❤ by Team Cyber Sentinels</p>
  </div>
</footer>

<style>
    .site-footer {
  background: #0b0f19;
  color: #ddd;
  padding: 60px 20px 20px;
  font-family: 'Segoe UI', sans-serif;
}

.footer-container {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-between;
  max-width: 1200px;
  margin: auto;
  gap: 40px;
}

.footer-brand h2 {
  color: #fff;
  font-size: 1.8rem;
  margin-bottom: 10px;
}

.footer-brand p {
  font-size: 0.95rem;
  line-height: 1.5;
}

.footer-links h4,
.footer-social h4 {
  color: #fff;
  margin-bottom: 15px;
  font-size: 1.2rem;
}

.footer-links ul {
  list-style: none;
  padding: 0;
}

.footer-links ul li {
  margin-bottom: 8px;
}

.footer-links ul li a {
  color: #ddd;
  text-decoration: none;
  font-size: 0.95rem;
  transition: color 0.3s;
}

.footer-links ul li a:hover {
  color: #ff7f32;
}

.footer-social .social-icons a {
  display: inline-block;
  color: #ddd;
  font-size: 1.2rem;
  margin-right: 12px;
  transition: color 0.3s;
}

.footer-social .social-icons a:hover {
  color: #ff7f32;
}

.footer-bottom {
  text-align: center;
  margin-top: 40px;
  padding-top: 20px;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.footer-bottom p {
  font-size: 0.9rem;
  color: #aaa;
}

.footer-bottom p span {
  color: #ff4d6d;
  font-weight: bold;
}

</style>


</body>
</html>